name: CI

on:
  push:
    branches:
      - master
      - main
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-22.04
    env:
      LLVM_VERSION: 21
      LLVM_ROOT: /usr/lib/llvm-21
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ninja-build \
            cmake \
            python3 \
            python3-pip \
            libedit-dev \
            libcurl4-openssl-dev \
            lsb-release \
            wget \
            gnupg \
            software-properties-common

      - name: Install LLVM toolchain (${LLVM_VERSION})
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh ${LLVM_VERSION}
          sudo apt-get install -y \
            clang-${LLVM_VERSION} \
            libclang-${LLVM_VERSION}-dev \
            libclang-common-${LLVM_VERSION}-dev \
            llvm-${LLVM_VERSION}-dev

      - name: Cache CMake/FetchContent deps
        uses: actions/cache@v4
        with:
          path: |
            build/_deps
            build/googletest-download
            build/googletest-subbuild
          key: ${{ runner.os }}-cmake-deps-${{ hashFiles('CMakeLists.txt', 'cmake/**', 'tests/**') }}

      - name: Configure (ninja-release)
        run: |
          cmake \
            --preset ninja-release \
            -DLLVM_DIR=${LLVM_ROOT}/lib/cmake/llvm \
            -DClang_DIR=${LLVM_ROOT}/lib/cmake/clang

      - name: Build
        run: cmake --build --preset ninja-release

      - name: Run tests
        run: ctest --preset ninja-release --output-on-failure
