name: CI

on:
  push:
    branches:
      - master
      - main
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-22.04
    env:
      LLVM_VERSION: 21.1.6
      LLVM_ARCHIVE: LLVM-21.1.6-Linux-X64
      LLVM_ROOT: ${{ github.workspace }}/llvm-21.1.6
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ninja-build \
            cmake \
            python3 \
            python3-pip \
            libedit-dev \
            libcurl4-openssl-dev \
            libffi-dev \
            libxml2-dev \
            zlib1g-dev \
            xz-utils \
            curl \
            lsb-release \
            wget \
            gnupg \
            software-properties-common

      - name: Cache LLVM toolchain
        id: cache-llvm
        uses: actions/cache@v4
        with:
          path: ${{ env.LLVM_ROOT }}
          key: ${{ runner.os }}-llvm-${{ env.LLVM_VERSION }}

      - name: Download LLVM toolchain
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        run: |
          curl -fL "https://github.com/llvm/llvm-project/releases/download/llvmorg-${LLVM_VERSION}/${LLVM_ARCHIVE}.tar.xz" -o llvm.tar.xz
          tar -xJf llvm.tar.xz
          mv "${LLVM_ARCHIVE}" "${LLVM_ROOT}"

      - name: Add LLVM to PATH
        run: echo "${LLVM_ROOT}/bin" >> "$GITHUB_PATH"

      - name: Cache CMake/FetchContent deps
        uses: actions/cache@v4
        with:
          path: |
            build/_deps
            build/googletest-download
            build/googletest-subbuild
          key: ${{ runner.os }}-cmake-deps-${{ hashFiles('CMakeLists.txt', 'cmake/**', 'tests/**') }}

      - name: Configure (ninja-release)
        run: |
          cmake \
            --preset ninja-release \
            -DLLVM_DIR=${LLVM_ROOT}/lib/cmake/llvm \
            -DClang_DIR=${LLVM_ROOT}/lib/cmake/clang \
            -DCLANG_TIDY_PATH=${LLVM_ROOT}/bin/clang-tidy

      - name: Build
        run: cmake --build --preset ninja-release

      - name: Run tests
        run: ctest --preset ninja-release --output-on-failure
